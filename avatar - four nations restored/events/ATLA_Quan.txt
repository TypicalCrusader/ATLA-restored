#####                                          #####
##                                                ##
##     Events behind Clan Authority and Story     ##
##  Written for T4N - Restored by TypicalCrusader ##
##                                                ##
#####                                          #####

namespace = T4NQuan

###      ###
#Event List#
###      ###

##T4NQuan.1 - Grant Trait princequan to new ruler
##T4NQuan.2 - Remove trait princequan if char is no longer a ruler of k_quan
##T4NQuan.3 - Check if CA is not < 0 / > 100 (yearly)
##T4NQuan.4 - Grant CA modifer based on current CA (yearly + startup)
##T4NQuan.5 - Assign tributes (startup)
##T4NQuan.6 - Clan Authority Yearly gain/loss (Yearly)
##T4NQuan.7 - Pre Scripted Mandate Revolt Event
##T4NQuan.8 - Five Banner Rebelion
##T4NQuan.9 - Declare Five Banners Rebelion
##T4NQuan.10 -
##T4NQuan.11 -
##T4NQuan.12 -
#####

#Grant Trait to new ruler
character_event = {
	id = T4NQuan.1
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		NOT = { trait = princequan }
		has_landed_title = k_quan
	}
	
	immediate = {
		#Default CA to 50 after previous ruler death
		set_variable = { which = global_Clanauthority value = 50 }
		add_trait = princequan
		
		clr_global_flag = CAgainblock
		clr_global_flag  = CAloseblock
	}
}

#Remove trait if char is no longer a ruler of k_quan
character_event = {
	id = T4NQuan.2
	is_triggered_only = yes
	hide_window = yes	
	
	trigger = {
		trait = princequan
		NOT = { has_landed_title = k_quan }
	}	
	
	immediate = { 
		remove_trait = princequan
	}
}

#Check if CA is not < 0  / > 100 (yearly)
character_event = {
	id = T4NQuan.3
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		has_landed_title = k_quan
	}
	
	immediate = {
		#if CA > 100 then set it to 100 and block any gain
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value > 100 }
			}
			set_variable = { which = global_Clanauthority value = 0 }
			set_global_flag = CAgainblock
		}
		#if CA < 0 then set it to 0 and block any lose
		else_if = {
			limit = {
				check_variable = { which = global_Clanauthority value < 0 }
			}		
			set_variable = { which = global_Clanauthority value = 0 }
			set_global_flag = CAloseblock
		}
		if = {
			limit = {
				has_global_flag = CAgainblock
				check_variable = { which = global_Clanauthority value <= 95 }
			}
			clr_global_flag = CAgainblock
		}
		else_if = {
			limit = {
				has_global_flag = CAloseblock
				check_variable = { which = global_Clanauthority value >= 5 }
			}
			clr_global_flag = CAloseblock
		}
	}
}

#Grant CA modifer based on current CA (yearly + startup)
character_event = {
	id = T4NQuan.4
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		has_landed_title = k_quan
	}

	immediate = {
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 0 }
				check_variable = { which = global_Clanauthority value <= 10 }
			}
			add_character_modifier = {
				name = CAmodif1
				years = -1
			}
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif9
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 10 }
				check_variable = { which = global_Clanauthority value <= 20 }
			} 	
			add_character_modifier = {
				name = CAmodif2
				years = -1
			}		
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif9
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 20 }
				check_variable = { which = global_Clanauthority value <= 30 }
			} 	
			add_character_modifier = {
				name = CAmodif3
				years = -1
			}		
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif9
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 30 }
				check_variable = { which = global_Clanauthority value <= 40 }
			} 	
			add_character_modifier = {
				name = CAmodif4
				years = -1
			}		
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif9
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 40 }
				check_variable = { which = global_Clanauthority value <= 60 }
			}			
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif9
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 60 }
				check_variable = { which = global_Clanauthority value <= 70 }
			} 	
			add_character_modifier = {
				name = CAmodif7
				years = -1
			}		
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif9
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 70 }
				check_variable = { which = global_Clanauthority value <= 80 }
			} 	
			add_character_modifier = {
				name = CAmodif8
				years = -1
			}		
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif9
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 80 }
				check_variable = { which = global_Clanauthority value <= 90 }
			} 	
			add_character_modifier = {
				name = CAmodif9
				years = -1
			}		
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif10
		}
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value >= 90 }
				check_variable = { which = global_Clanauthority value <= 100 }
			} 	
			add_character_modifier = {
				name = CAmodif10
				years = -1
			}		
			remove_character_modifier = CAmodif1
			remove_character_modifier = CAmodif2
			remove_character_modifier = CAmodif3
			remove_character_modifier = CAmodif4
			remove_character_modifier = CAmodif7
			remove_character_modifier = CAmodif8
			remove_character_modifier = CAmodif9
		}		
	}
}

character_event = {
	id = T4NQuan.5
	only_rulers = yes
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		is_save_game = no
	}

	immediate = {
		#any_independent_ruler = {
		if = {	
			limit = {
				capital_scope = {
					region = world_dongfang_peninsular
				}
				is_tribal = yes
				rebel = no
				#independent = yes
				NOT = { has_character_flag = LowCARevolter }
			}
			suzerain = {
				remove_tributary = PREV
			}			
			k_quan = {
				owner = {
					make_tributary = {
						who = ROOT
						percentage = 0.2
						tributary_type = quan_tributary
					}
				}
			}
		}
	}
}

character_event = {
	id = T4NQuan.6 
	is_triggered_only = yes
	only_rulers = yes

	picture = GFX_evt_chin_war
	desc = QuanYearlycheckdesc

	trigger = {
		has_landed_title = k_quan
		NOR = {
			has_global_flag = CAgainblock
			has_global_flag = CAloseblock
		}
	}

	immediate = {
	
		set_variable = { which = oldclanauthority which = global_Clanauthority }
		set_variable = { which = CA_lawgain value = 0 }
		set_variable = { which = CA_mileducationgain value = 0 }
		set_variable = { which = global_CA_randomgain value = 0 }
		set_variable = { which = CA_tributesgain value = 0 }

		ROOT = {

			#Tributaries
			any_tributary = {
				if = {
					limit = {
						is_tributary = {
							tributary_type = quan_tributary
						}				
					}
					change_variable = { which = CA_tributesgain value = 1 }
				}
			}

			#Military education Traits + Strategist trait 
			trigger_switch = {
				on_trigger = trait

				misguided_warrior = { change_variable = { which = CA_mileducationgain value = 0.5 } }
				tough_soldier = { change_variable = { which = CA_mileducationgain value = 1 } }
				skilled_tactician = { change_variable = { which = CA_mileducationgain value = 1.5 } }
				brilliant_strategist = { change_variable = { which = CA_mileducationgain value = 2 } }
			}

			trigger_switch = {
				on_trigger = trait

				strong = { change_variable = { which = CA_mileducationgain value = 1 } }
				weak = { change_variable = { which = CA_mileducationgain value = -1 } }
			}

			if = {
				limit = {
					NOR = {
						trait = misguided_warrior
						trait = tough_soldier
						trait = skilled_tactician 
						trait = brilliant_strategist
					}
				}
				change_variable = { which = CA_mileducationgain value = -1 }
			}

			if = {
				limit = {
					trait = strategist
				}
				change_variable = { which = CA_mileducationgain value = 1.5 }
			}

			#TODO:Laws go here, when they will be done
		}
		
		
		
		change_variable = { which = global_Clanauthority which = CA_tributesgain }
		change_variable = { which = global_Clanauthority which = CA_mileducationgain }
		change_variable = { which = global_Clanauthority which = CA_lawgain }
		change_variable = { which = global_Clanauthority which = global_CA_randomgain }
			
		set_variable = { which = CAgain which = global_Clanauthority }
		subtract_variable = { which = CAgain which = oldclanauthority }

		if = {
			limit = {
				OR = {
					check_variable = { which = global_Clanauthority value > 100 }
					check_variable = { which = global_Clanauthority value < 0 } 
				}
			}
			if = {
				limit = {
					check_variable = { which = global_Clanauthority value > 100 }
				}
				character_event = { id = T4NQuan.3 }
			}
			else_if = {
				limit = {
					check_variable = { which = global_Clanauthority value < 0 }					
				}
				character_event = { id = T4NQuan.3 }
			}
		}

	}

	option = {
		name = QuanYearlycheckopt
		custom_tooltip = {
			text = QuanYearlycheck
		}
	}
}

#Pre Scripted Mandate Revolt Event
narrative_event = {
	id = T4NQuan.7
	only_rulers = yes
	is_triggered_only = yes
	
	picture = GFX_evt_suspicious_noble
	border = GFX_event_narrative_frame_intrigue
	title = QuanPreRevoltEvtTit
	desc = QuanPreRevoltEvtDesc

	trigger = {
		has_landed_title = k_quan
		k_quan = {	
			OR = {
				AND = {
					has_law = quan_army_5
					has_law = quan_council_4
					has_law = quan_admin_3
				}
				AND = {
					has_law = quan_army_5
					has_law = quan_council_6
					#TODO:after testing add all other conclave council law
				}
			}
		}
	}

	immediate = {
		character_event = { id = T4NQuan.8 years = 1 }
	}

	option = {
		name = QuanPreRevoltEvtOpt
		custom_tooltip = {
			text = Quan_alea_iacta_est
			hidden_tooltip = {
				set_global_flag = Quan_the_die_is_cast
			}
		}
	}
}

#Five Banners revolt
#T h i c c 

narrative_event = {
	id = T4NQuan.8
	is_triggered_only = yes
	only_rulers = yes
	picture = GFX_evt_china_unrest
	title = QuanFiveBannersTit
	desc = QuanFiveBannersDesc
	
	trigger = {
		has_global_flag = Quan_the_die_is_cast
		has_landed_title = k_quan
	}
	
	immediate = {
		change_variable = { which = global_Clanauthority value = -15 }
		if = {
			limit = {
				check_variable = { which = global_Clanauthority value < 0 }
			}
			character_event = { id = T4NQuan.3 }
		}
	}
	
	option = {
		name = QuanFiveBannersOpt
		custom_tooltip = {
			text = Quan_rebelion_begins
			hidden_tooltip = {
				c_nayong = {
					holder_scope = {
						set_character_flag = Quan_Five_banners_member
						random_list = {
						80 = { }
						20 = { 
							if = {
								limit = {
									any_playable_ruler = {
										limit = {
											culture = dongfangian
											NOT = { has_character_flag = Quan_Five_banners_Leader }
											}
										}
									}
									save_event_target_as = Quan_Five_Banners_leader
									set_character_flag = Quan_Five_banners_Leader
									event_target:Quan_Five_Banners_leader = {
										character_event = { id = T4NQuan.9 }
									}																		
								}
							}
						}
					}
				}
				c_qijing = {
					holder_scope = {
						set_character_flag = Quan_Five_banners_member
						random_list = {
						70 = { }
						30 = { 
							if = {
								limit = {
									any_playable_ruler = {
										limit = {
											culture = dongfangian
											NOT = { has_character_flag = Quan_Five_banners_Leader }
											}
										}
									}
									save_event_target_as = Quan_Five_Banners_leader
									set_character_flag = Quan_Five_banners_Leader
									event_target:Quan_Five_Banners_leader = {
										character_event = { id = T4NQuan.9 }
									}																		
								}
							}
						}
					}
				}
				c_jejin = {
					holder_scope = {
						set_character_flag = Quan_Five_banners_member
						random_list = {
						70 = { }
						30 = { 
							if = {
								limit = {
									any_playable_ruler = {
										limit = {
											culture = dongfangian
											NOT = { has_character_flag = Quan_Five_banners_Leader }
											}
										}
									}
									save_event_target_as = Quan_Five_Banners_leader
									set_character_flag = Quan_Five_banners_Leader
									event_target:Quan_Five_Banners_leader = {
										character_event = { id = T4NQuan.9 }
									}																		
								}
							}
						}
					}
				}
				c_tangong = {
					holder_scope = {
						set_character_flag = Quan_Five_banners_member
						random_list = {
						90 = { }
						10 = { 
							if = {
								limit = {
									any_playable_ruler = {
										limit = {
											culture = dongfangian
											NOT = { has_character_flag = Quan_Five_banners_Leader }
											}
										}
									}
									save_event_target_as = Quan_Five_Banners_leader
									set_character_flag = Quan_Five_banners_Leader
									event_target:Quan_Five_Banners_leader = {
										character_event = { id = T4NQuan.9 }
									}																		
								}
							}
						}
					}
				}
				c_tanghua = {
					holder_scope = {
						set_character_flag = Quan_Five_banners_member
						random_list = {
						30 = { }
						70 = { 
							if = {
								limit = {
									any_playable_ruler = {
										limit = {
											culture = dongfangian
											NOT = { has_character_flag = Quan_Five_banners_Leader }
											}
										}
									}
									save_event_target_as = Quan_Five_Banners_leader
									set_character_flag = Quan_Five_banners_Leader
									event_target:Quan_Five_Banners_leader = {
										character_event = { id = T4NQuan.9 }
									}									
								}
							}
						}
						if = { #if noone will gain the five banners leader give it to Clan Bei
							limit = {	
								any_playable_ruler = {
									limit = {
										culture = dongfangian
										NOT = { has_character_flag = Quan_Five_banners_Leader }
										}
									}
								}
							save_event_target_as = Quan_Five_Banners_leader
							set_character_flag = Quan_Five_banners_Leader
							event_target:Quan_Five_Banners_leader = {
								character_event = { id = T4NQuan.9 }
							}
						}	
					}
				}				
			}
		}
	}
}

character_event = {
	id = T4NQuan.9
	is_triggered_only = yes
	only_rulers = yes
	hide_window = yes
	
	
	trigger = {
		has_character_flag = Quan_Five_banners_Leader
		has_global_flag = Quan_the_die_is_cast
	}
	
	immediate = {
		ROOT = {
			k_quan = {
				remove_tributary = ROOT
			}
			primary_title = {
				holder_scope = {
					activate_title = { title = k_five_banners status = yes }
					grant_title = k_five_banners
				}
			}
			k_five_banners = {
				holder_scope = {
					copy_title_laws = FROMFROM
					copy_title_history = FROMFROM				
					#o h  b o i now you fucked up
					spawn_unit = {
						owner = ROOT
						province = ROOT
						home = ROOT			
						
						troops = {
							archers = { 1000 1000 }
							light_infantry = { 1500 1500 }
							light_cavalry = { 2500 2500 }
						}

						attrition = 1.0
						disband_on_peace = yes
						maintenance_multiplier = 0.5
					}						
				}
			}	
		}
		any_playable_ruler = {
			limit = {
				culture = dongfangian
				has_character_flag = Quan_Five_banners_member
				NOT = { has_character_flag = Quan_Five_banners_Leader }
			}
			k_quan = {
				remove_tributary = PREV
			}
			primary_title = {
				set_defacto_liege = ROOT
			}
		}
		k_quan = {
			holder_scope = {
				reverse_war = {
					target = PREV
					casus_belli = Quan_scripted_revolt_cb
				}
			}
		}
	}
}
	
	
	
	

#Random gain events